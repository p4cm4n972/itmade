name: Deploy Frontend to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy Frontend (first + next deployments)
        run: |
          ssh ubuntu@"${{ secrets.SSH_HOST }}" << 'EOF'
            set -e

            APP_DIR="/var/www/itmade/itmade"
            PARENT_DIR="/var/www/itmade"

            # 1) Création du dossier parent si besoin
            if [ ! -d "$PARENT_DIR" ]; then
              sudo mkdir -p "$PARENT_DIR"
              sudo chown -R ubuntu:ubuntu "$PARENT_DIR"
            fi

            cd "$PARENT_DIR"

            # 2) Premier déploiement : si pas encore de repo, on clone
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "➡️ Premier déploiement : clonage du repo..."
              git clone git@github.com:p4cm4n972/itmade .git itmade
            fi

            cd "$APP_DIR"

            echo "➡️ Pull des dernières modifications..."
            git pull origin main

            echo "➡️ Installation des dépendances..."
            npm install

            # 3) Variables d'environnement pour le build
            export API_BASE_URL="${{ secrets.API_BASE_URL }}"
            export EMAILJS_SERVICE_ID="${{ secrets.EMAILJS_SERVICE_ID }}"
            export EMAILJS_TEMPLATE_ID="${{ secrets.EMAILJS_TEMPLATE_ID }}"
            export EMAILJS_PUBLIC_KEY="${{ secrets.EMAILJS_PUBLIC_KEY }}"

            # Valeur par défaut si API_BASE_URL est vide
            if [ -z "$API_BASE_URL" ]; then
              API_BASE_URL="http://127.0.0.1:3000"
            fi

            echo "➡️ Build Angular SSR..."
            npm run build

            # 4) PM2 : démarrage ou restart
            if pm2 list | grep -q "itmade"; then
              echo "➡️ Restart PM2 process itmade..."
              pm2 restart itmade
            else
              echo "➡️ Premier démarrage PM2..."
              pm2 start ecosystem.config.js --only itmade --name itmade
            fi

            pm2 save
          EOF
