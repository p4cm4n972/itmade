- name: Deploy Frontend (ITMade SSR)
  run: |
    ssh ubuntu@"${{ secrets.SSH_HOST }}" << 'EOF'
      set -e

      APP_DIR="/var/www/itmade/itmade"
      PARENT_DIR="/var/www/itmade"

      # 1) Création du dossier parent si besoin
      if [ ! -d "$PARENT_DIR" ]; then
        sudo mkdir -p "$PARENT_DIR"
        sudo chown -R ubuntu:ubuntu "$PARENT_DIR"
      fi

      cd "$PARENT_DIR"

      # 2) Premier déploiement : si le repo n'existe pas encore, on le clone
      if [ ! -d "$APP_DIR/.git" ]; then
        echo "➡️ Premier déploiement : clonage du repo..."
        git clone git@github.com:p4cm4n972/itmade.git itmade
      fi

      cd "$APP_DIR"

      echo "➡️ Pull des dernières modifications..."
      git pull origin main

      echo "➡️ Installation / mise à jour des dépendances..."
      npm install

      # 3) Variables d'env éventuelles pour le build Angular
      export API_BASE_URL="${{ secrets.API_BASE_URL }}"
      export EMAILJS_SERVICE_ID="${{ secrets.EMAILJS_SERVICE_ID }}"
      export EMAILJS_TEMPLATE_ID="${{ secrets.EMAILJS_TEMPLATE_ID }}"
      export EMAILJS_PUBLIC_KEY="${{ secrets.EMAILJS_PUBLIC_KEY }}"

      if [ -z "$API_BASE_URL" ]; then
        API_BASE_URL="http://127.0.0.1:3000"
      fi

      echo "➡️ Build SSR..."
      npm run build

      # 4) Redémarrage du SSR avec PM2 via start-itmade.sh
      echo "➡️ Restart PM2 itmade-ssr..."
      if pm2 list | grep -q "itmade-ssr"; then
        pm2 restart itmade-ssr
      else
        pm2 start /var/www/itmade/itmade/start-itmade.sh --name itmade-ssr
      fi

      pm2 save
    EOF
